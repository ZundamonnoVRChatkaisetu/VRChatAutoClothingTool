# VRChat Auto Clothing Tool - 進捗管理

## プロジェクト概要
VRChatで使用するアバターに衣装を自動で着せるツールを作成するプロジェクト。Boothなどで販売されている衣装は特定のアバターに最適化されているため、異なるアバターに着せる場合は手動調整が必要になる。このツールは、そのプロセスを自動化することを目的としている。

## 主な機能
- アバターと衣装のボーン構造の違いを考慮した自動調整
- 衣装のサイズをアバターの体型に合わせて自動調整
- Unity Editor内でのシンプルなUIを提供
- ボーンマッピングの手動調整機能
- 調整前のプレビュー機能
- 衣装の貫通検出と自動調整機能
- 衣装の微調整UI（リアルタイム反映）
- VRChat特有のボーンやコンポーネントに対応

## 技術的前提
- アバターと衣装でボーンの構造が異なる
- Unityで実装（C#）
- Unity 2019.4.31f1以上（VRChat SDK対応バージョン）

## 進捗状況

### 2025-03-19
- ✅ プロジェクトリポジトリを作成
- ✅ 進捗管理ファイルを作成
- ✅ 参考資料の分析を実施
- ✅ メインエディタウィンドウ（AutoClothingWindow.cs）を実装
- ✅ ボーン調整ユーティリティ（BoneAdjuster.cs）を実装
- ✅ VRChat特有のアバター処理ユーティリティ（VRChatAvatarUtility.cs）を実装
- ✅ メッシュ処理ユーティリティ（MeshUtility.cs）を実装
- ✅ 詳細なREADMEと使用方法の作成
- ✅ 追加の特定ボーン（UpperLeg.L/R、Shoulder.L/R等）へのサポートを追加
- ✅ 衣装がアバターに貫通しないようにチェックする処理を強化
- ✅ 衣装の微調整UI改良とリアルタイム反映機能の追加
- ✅ 全体の実装完了

### 2025-03-20
- ✅ 貫通検出の機能強化と精度向上
  - 複数のアバターメッシュとの貫通チェックに対応
  - より精密な貫通深度の検出と調整機能の実装
  - 貫通検出設定のカスタマイズUIを追加
- ✅ 衣装の微調整機能の向上
  - リアルタイム調整反映機能の改良
  - 調整の確定・リセット機能の強化
  - 部位ごとのサイズと位置の調整機能を追加
- ✅ コードの大規模なリファクタリング
  - 機能ごとに専用クラスに分割し保守性を向上
  - MeshUtility.cs → 基本的なメッシュ操作
  - PenetrationDetection.cs → 貫通検出・調整
  - BoneWeightUtility.cs → ボーンウェイト処理
  - MeshTransformation.cs → メッシュ変形・調整
  - BoneStructureAnalyzer.cs → ボーン構造分析
  - ClothingAdjuster.cs → 衣装調整メイン処理
  - FineAdjustmentHandler.cs → 微調整処理

### 2025-03-21
- ✅ 貫通部分のメッシュ形状維持機能の実装
  - 衣装の形状を崩さないようにラプラシアン平滑化アルゴリズムを追加
  - 貫通箇所の頂点調整時に近傍頂点も考慮する機能
  - 形状維持の有効/無効と強度を切り替える設定オプション
- ✅ 部位ごとのサイズ調整機能の追加
  - 胸部/腰部/腕/脚/頭/背中などの部位別調整UI
  - 部位に対応するボーン検出アルゴリズムの実装
  - 部位ごとのスケール値保存機能
- ✅ 部位ごとの位置調整機能の追加
  - 部位単位の位置オフセット調整UI
  - 部位の親ボーン特定アルゴリズムの実装
  - 変更のリアルタイム反映処理
- ✅ ボーン名パターンの拡張
  - Upper_leg.L や Upper_leg.R など様々な命名パターンに対応
  - 大文字小文字を区別しない処理を追加
  - スマートボーンマッチングアルゴリズムの実装

### 2025-03-22 (バグ修正)
- ✅ 衣装が見えなくなる問題を修正
  - マテリアルの透明設定処理を改善
  - nullマテリアルのエラーハンドリング追加
  - 透明シェーダーの検出と処理強化
  - マテリアル処理時の例外ハンドリング追加
  - プレビュー時のマテリアル処理を改善

### 2025-03-23 (機能改善)
- ✅ ボーンマッピングの精度向上
  - ボーン名マッチングアルゴリズムの大幅改善
  - セマンティック解析による正確なボーン対応付け
  - 複数の命名パターンに対するよりスマートな検出
  - スコアベースのマッチングシステム導入
  - UpperLeg_R→Upper_Leg_Rなどの特殊パターン対応強化
  - 画面表示されるボーン選択の精度向上
  - ボーン名パターンのデータベース拡充

### 2025-03-24 (バグ修正・機能改善)
- ✅ 非標準ボーン対応の強化 (「Himo_L」などのカスタムパーツ対応)
  - カスタムボーン検出機能の実装
  - マッピングされないボーンに親のボーンマッピングを継承させる機能追加
  - 装飾部品や特殊パーツに対するボーン対応の強化
  - イヤリング、紐、装飾品などの専用処理を追加
- ✅ 部位別スケール調整時の崩壊問題を修正
  - スケール変更時の二重適用問題を解決
  - 部位ごとに元のスケール値を保存する機能追加
  - 部位選択切替時の状態リセット防止機能
  - スケーリング階層の正確な処理を実装
- ✅ バインドポーズの更新処理を強化
  - メッシュのバインドポーズ更新アルゴリズムを改善
  - スキニングウェイトの継承問題を修正
  - マッピングされていないボーンの階層関係維持
  - 衣装全体のマッピング安定性向上

### 2025-03-25 (機能拡張)
- ✅ マッピングされないボーンの処理を完全改良
  - ボーンの親子関係を保持したマッピング方式に変更
  - 親ボーンの相対位置・回転を保存する処理を追加
  - 未マッピングボーンの視覚的表示を追加
  - マッピングされないすべてのカスタムボーンに対応
- ✅ スケーリング設定用リアルタイムプレビュー機能の追加
  - スケール変更時のリアルタイムプレビュー表示
  - スケール調整前のサイズ確認が可能に
  - 微調整前に最適なスケール確認が可能
  - プレビュー用の半透明表示モード追加
- ✅ BoneMappingクラスの分離とシステム拡張
  - BoneMappingを独立したクラスファイルに分割
  - スマートボーンマッピング処理の強化
  - Unmappedフラグと元データ参照機能の追加
  - マッピング関連情報の効率的な管理

### 2025-03-26 (機能強化)
- ✅ 手足の重要ボーン（Hand_L/R、Foot_L/R、Toe_L/R）のマッピング強化
  - 親子関係を使用した階層的ボーン検索機能を追加
  - LowerArm→Hand、LowerLeg→Foot、Foot→Toeなどの親子関係の検出と適用
  - ボーンの位置ベースのマッチング精度向上
  - 左右対称性を考慮した追加マッピング
  - マッピング優先度付けの仕組みを改良
- ✅ マッピングUIの改良
  - マッピングの追加・削除ボタンの使いやすさ向上
  - 一目でマッピング状況がわかるUI表示の強化
  - 未マッピングボーンの視覚的な区別表示
  - 重要ボーンのマッピング状況優先表示

## 実装内容

### 1. メインエディタウィンドウ（AutoClothingWindow.cs）
- Unityエディタ拡張ウィンドウの実装
- アバターと衣装の選択UI
- ボーンマッピング表示・編集UI
- スケーリング設定UI
- プレビュー・適用機能
- 衣装の微調整UI（リアルタイム反映）
- 貫通検出設定UI
- スケーリングリアルタイムプレビュー機能

### 2. ボーン関連機能（BoneStructureAnalyzer.cs, BoneAdjuster.cs, BoneMapping.cs）
- ボーン構造の分析・マッピング機能
- 最も近いボーンを検索する機能
- 衣装のボーンをアバターのボーンに合わせて調整する機能
- スキンメッシュレンダラーの調整機能
- 追加ボーンパターン対応（ドット形式とアンダースコア形式の両方をサポート）
- スマートなボーンパターンマッチング機能
- セマンティックボーン解析による精度向上
- カスタムボーン（装飾品など）の専用処理
- 未マッピングボーンの相対位置保持機能
- 親子関係を利用した階層的ボーン検索と対応付け
- 手足の重要ボーン（Hand、Foot、Toeなど）の特別処理

### 3. VRChat特有のアバター処理（VRChatAvatarUtility.cs）
- アバータータイプの検出機能
- VRChatコンポーネントの識別機能
- アバターと衣装のスケール差の計算機能
- ダイナミックボーンやPhysBoneの調整機能

### 4. メッシュ処理機能（MeshUtility.cs, MeshTransformation.cs, BoneWeightUtility.cs）
- スキンメッシュの調整処理
- ボーンウェイトの再分配機能
- バインドポーズの再計算機能
- メッシュのミラーリング機能
- マテリアルテクスチャのスケーリング調整機能

### 5. 貫通検出と調整機能（PenetrationDetection.cs）
- 複数のアバターメッシュとの貫通チェック
- より精密な貫通深度の検出
- 複数の貫通に対する最適な調整方向の決定
- 優先順位付きメッシュ処理（ボディメッシュ優先）
- 高精度/低精度サンプリングの切り替え
- ラプラシアン平滑化による形状維持機能
- カスタマイズ可能な設定パラメータ

### 6. 衣装調整機能（ClothingAdjuster.cs）
- 衣装の自動調整処理の統合
- Undo対応
- プレビュー生成
- エラーハンドリング
- プレビュー用半透明マテリアルの適用
- マテリアル透明度問題の修正と堅牢性向上
- カスタムボーン専用処理の追加
- リアルタイムスケーリングプレビュー機能

### 7. 微調整機能（FineAdjustmentHandler.cs）
- リアルタイムでの調整反映
- 全体および部位ごとのサイズ調整
- 全体および部位ごとの位置調整
- 全体の回転調整
- 調整のリセット・確定機能
- プリセット適用機能
- 部位ごとの元スケール保存機能

## 未実装の機能と今後の課題

### 未実装の機能
- ❌ 部位ごとの回転調整機能（技術的難易度が高く保留中）
- ❌ モーフターゲットを利用した体型調整（より高度な体型合わせが必要な場合向け）
- ❌ アバター特性に基づいた推奨衣装調整設定の自動提案機能
- ❌ 調整履歴の保存と読み込み機能（好みの調整を再利用するため）
- ❌ 複数衣装の同時調整機能

### 解決すべき技術的課題
- ❌ 深度バッファの活用による高精度貫通検出（現在はメッシュ交差計算による検出）
- ❌ 重力シミュレーションを考慮した衣装調整（落ち着いた状態を予測）
- ❌ 非ヒューマノイドアバターの衣装調整方法の改善
- ❌ 分散処理による大規模メッシュの高速処理
- ❌ 部位ごとの回転調整でのボーン階層維持問題
- ❌ Unity 2022以降のシリアライズシステムとの互換性対応

### パフォーマンス改善項目
- ❌ 頂点処理の最適化（SIMD命令の活用）
- ❌ マルチスレッド対応による貫通検出の高速化
- ❌ メモリ使用量の削減（大規模メッシュでのGC抑制）
- ❌ ボーンマッピングの検索アルゴリズム改善

## 今後の計画

### 優先度高（次回更新予定）
- ⭐ 部位ごとの回転調整機能の実装
- ⭐ プリセット保存・読み込み機能
- ⭐ 貫通検出アルゴリズムのパフォーマンス改善

### 優先度中
- 📅 バッチ処理（複数の衣装を一括調整）
- 📅 チュートリアルウィザードの追加
- 📅 日本語・英語の言語切り替え機能

### 長期計画
- 📆 VRChat SDK 3.0のExpressionParametersとの連携
- 📆 体格差の大きいアバター間での着せ替え支援
- 📆 アバタープロポーションの自動分析と最適化提案

## 検証状況
- ✅ 基本機能の実装は完了
- ✅ 改良された貫通検出機能のテスト完了
- ✅ ボーンマッピング拡張のテスト完了
- ✅ 部位ごとの調整機能のテスト完了
- ✅ 形状維持アルゴリズムの実装と動作確認完了
- ✅ 衣装の透明化問題の修正とテスト完了
- ✅ ボーンマッピング精度の向上とテスト完了
- ✅ 非標準ボーン対応の強化とテスト完了
- ✅ 部位別スケール調整時の崩壊問題修正を確認
- ✅ スケール調整リアルタイムプレビュー機能のテスト完了
- ✅ 手足の重要ボーン（Hand、Foot、Toe）のマッピング強化のテスト完了
- ⚠️ 様々なアバターモデルでのテストが必要
- ⚠️ 複雑な衣装での検証が不十分
- ⚠️ モバイル対応VRChatモデルでのパフォーマンス検証が必要
